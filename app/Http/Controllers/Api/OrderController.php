<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Models\Order;
use App\Models\OrderItem;
use App\Models\CartSession;
use App\Models\CartItem;
use App\Models\User;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class OrderController extends Controller
{


    /**
     * Cr√©er une commande √† partir du panier (validation via WhatsApp)
     * 
     * @param Request $request - Donn√©es de la commande
     * @return JsonResponse - Commande cr√©√©e avec r√©sum√©
     */
    public function store(Request $request): JsonResponse
    {
        try {
            // Validation des donn√©es
            $validator = Validator::make($request->all(), [
                'session_id' => 'required|string',
                'notes' => 'nullable|string|max:1000',
                'whatsapp_phone' => 'nullable|string'
            ], [
                'session_id.required' => 'L\'ID de session du panier est requis',
                'notes.max' => 'Les notes ne peuvent pas d√©passer 1000 caract√®res'
            ]);

            // Si validation √©choue, retourner les erreurs
            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Erreur de validation',
                    'errors' => $validator->errors()
                ], 422);
            }

            // R√©cup√©rer la session du panier
            $cartSession = CartSession::where('session_id', $request->session_id)
                ->where('expires_at', '>', now())
                ->with(['items.product', 'items.variant'])
                ->first();

            if (!$cartSession) {
                return response()->json([
                    'success' => false,
                    'message' => 'Session de panier invalide ou expir√©e'
                ], 404);
            }

            // V√©rifier que le panier n'est pas vide
            if ($cartSession->items->isEmpty()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Le panier est vide'
                ], 422);
            }

            // V√©rifier la disponibilit√© des produits
            $unavailableItems = [];
            foreach ($cartSession->items as $item) {
                if ($item->variant) {
                    if (!$item->variant->isAvailable()) {
                        $unavailableItems[] = $item->product->name . ' - ' . $item->variant->name;
                    }
                } elseif (!$item->product->is_active) {
                    $unavailableItems[] = $item->product->name;
                }
            }

            if (!empty($unavailableItems)) {
                return response()->json([
                    'success' => false,
                    'message' => 'Certains produits ne sont plus disponibles',
                    'error' => 'Produits indisponibles : ' . implode(', ', $unavailableItems)
                ], 422);
            }

            // D√©marrer une transaction
            DB::beginTransaction();

            try {
                // Calculer le total de la commande
                $totalAmount = $cartSession->items->sum(function ($item) {
                    $price = $item->variant ? $item->variant->price : ($item->product->base_price ?? 0);
                    return $price * $item->quantity;
            });

            // D√©terminer le client pour la commande
            $clientId = null;
            $user = $request->user();
            
            \Log::info('üîç D√©termination du client pour la commande', [
                'session_id' => $request->session_id,
                'cart_session_client_id' => $cartSession->client_id,
                'authenticated_user_id' => $user ? $user->id : null,
                'authenticated_user_email' => $user ? $user->email : null,
                'request_headers' => $request->headers->all(),
                'auth_header' => $request->header('Authorization')
            ]);
            
            if ($user) {
                // PRIORIT√â 1: Utiliser l'utilisateur connect√©
                $clientId = $user->id;
                \Log::info('‚úÖ Utilisation de l\'utilisateur connect√©', ['client_id' => $clientId]);
                
                // Mettre √† jour la session du panier avec l'utilisateur connect√©
                if (!$cartSession->client_id || $cartSession->client_id !== $user->id) {
                    $cartSession->update(['client_id' => $user->id]);
                    \Log::info('üîÑ Session panier mise √† jour avec l\'utilisateur connect√©');
                }
            } elseif ($cartSession->client_id) {
                // PRIORIT√â 2: Utiliser le client existant de la session
                $clientId = $cartSession->client_id;
                \Log::info('‚úÖ Utilisation du client de la session', ['client_id' => $clientId]);
            } else {
                // PRIORIT√â 3: Cr√©er un utilisateur temporaire seulement si n√©cessaire
                \Log::info('‚ö†Ô∏è Cr√©ation d\'un utilisateur temporaire');
                $tempUser = User::create([
                    'name' => 'Client ' . substr($request->session_id, -6),
                    'email' => 'temp_' . time() . '@bs-shop.com',
                    'whatsapp_phone' => '+33000000000', // T√©l√©phone temporaire
                    'role' => 'client',
                    'password' => bcrypt(Str::random(16)),
                    'is_active' => true
                ]);
                $clientId = $tempUser->id;
                
                // Mettre √† jour la session avec le nouvel utilisateur
                $cartSession->update(['client_id' => $clientId]);
                \Log::info('üÜï Nouvel utilisateur temporaire cr√©√©', ['client_id' => $clientId]);
            }

            // Cr√©er la commande
            \Log::info('üì¶ Cr√©ation de la commande', [
                'client_id' => $clientId,
                'total_amount' => $totalAmount,
                'authenticated_user_id' => $user ? $user->id : null
            ]);
            
            $order = Order::create([
                'client_id' => $clientId,
                'total_amount' => $totalAmount,
                'status' => 'en_attente',
                'notes' => $request->notes,
                'whatsapp_message_id' => null // Sera rempli apr√®s envoi WhatsApp
            ]);
            
            \Log::info('‚úÖ Commande cr√©√©e avec succ√®s', [
                'order_id' => $order->id,
                'client_id' => $order->client_id,
                'total_amount' => $order->total_amount
            ]);

            // Cr√©er les √©l√©ments de commande
                foreach ($cartSession->items as $cartItem) {
                    $unitPrice = $cartItem->variant ? $cartItem->variant->price : ($cartItem->product->base_price ?? 0);
                    $totalPrice = $unitPrice * $cartItem->quantity;

                OrderItem::create([
                    'order_id' => $order->id,
                        'product_id' => $cartItem->product_id,
                        'product_variant_id' => $cartItem->product_variant_id,
                        'quantity' => $cartItem->quantity,
                        'unit_price' => $unitPrice,
                        'total_price' => $totalPrice
                    ]);

                    // Mettre √† jour le stock si c'est une variante
                    if ($cartItem->variant && $cartItem->variant->stock_quantity !== null) {
                        $cartItem->variant->decrement('stock_quantity', $cartItem->quantity);
                    }
                }

                // Vider le panier
                $cartSession->items()->delete();

                // Valider la transaction
                DB::commit();

                // Charger les relations pour la r√©ponse
                $order->load(['items.product', 'items.variant', 'client']);

                // Formater la r√©ponse
                $formattedOrder = [
                    'id' => $order->id,
                    'order_number' => 'CMD-' . str_pad($order->id, 6, '0', STR_PAD_LEFT),
                    'status' => $order->status,
                    'total_amount' => $order->total_amount,
                    'notes' => $order->notes,
                    'client_info' => [
                        'id' => $order->client_id,
                        'name' => $order->client->name,
                        'email' => $order->client->email,
                        'is_existing_user' => $user ? true : false
                    ],
                    'items' => $order->items->map(function ($item) {
                        return [
                            'product_name' => $item->product->name,
                            'variant_name' => $item->variant ? $item->variant->name : null,
                            'quantity' => $item->quantity,
                            'unit_price' => $item->unit_price,
                            'total_price' => $item->total_price
                        ];
                    }),
                    'summary' => [
                        'total_items' => $order->items->sum('quantity'),
                        'items_count' => $order->items->count(),
                        'created_at' => $order->created_at
                    ]
                ];

                return response()->json([
                    'success' => true,
                    'message' => 'Commande cr√©√©e avec succ√®s ! Pr√©parez-vous pour la validation WhatsApp.',
                    'data' => [
                        'order' => $formattedOrder,
                        'whatsapp_message' => $this->generateWhatsAppMessage($order),
                        'next_steps' => [
                            '1' => 'V√©rifiez le r√©sum√© de votre commande ci-dessus',
                            '2' => 'Envoyez le message WhatsApp pour confirmer',
                            '3' => 'Attendez la confirmation de l\'administrateur'
                        ]
                    ]
                ], 201);

            } catch (\Exception $e) {
                // Annuler la transaction en cas d'erreur
                DB::rollBack();
                throw $e;
            }

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors de la cr√©ation de la commande',
                'error' => 'Une erreur est survenue'
            ], 500);
        }
    }

    /**
     * Liste des commandes du client connect√©
     * 
     * @param Request $request - Requ√™te avec utilisateur connect√©
     * @return JsonResponse - Liste des commandes du client
     */
    public function index(Request $request): JsonResponse
    {
        try {
            \Log::info('üîç OrderController::index - D√©but de la requ√™te');
            
            // R√©cup√©rer l'utilisateur connect√©
            $user = $request->user();
            \Log::info('üë§ Utilisateur connect√©:', ['user_id' => $user ? $user->id : null, 'email' => $user ? $user->email : null]);
            
            if (!$user) {
                \Log::warning('‚ùå Utilisateur non connect√©');
                return response()->json([
                    'success' => false,
                    'message' => 'Utilisateur non connect√©'
                ], 401);
            }

            // R√©cup√©rer les commandes du client avec tous les d√©tails
            \Log::info('üîç Recherche des commandes pour client_id:', ['client_id' => $user->id]);
            
            $orders = Order::where('client_id', $user->id)
                ->with([
                    'items.product.category', 
                    'items.variant',
                    'client'
                ])
                ->orderBy('created_at', 'desc')
                ->get();
            
            \Log::info('üì¶ Commandes trouv√©es:', ['count' => $orders->count()]);

            // Formater les commandes avec tous les d√©tails
            $formattedOrders = $orders->map(function ($order) {
                \Log::info('üìã Formatage commande ID:', ['order_id' => $order->id, 'items_count' => $order->items->count()]);
                
                return [
                    'id' => $order->id,
                    'order_number' => 'CMD-' . str_pad($order->id, 6, '0', STR_PAD_LEFT),
                    'status' => $order->status,
                    'total_amount' => $order->total_amount,
                    'notes' => $order->notes,
                    'items' => $order->items->map(function ($item) {
                        return [
                            'id' => $item->id,
                            'product_id' => $item->product_id,
                            'product_name' => $item->product->name,
                            'product_variant_id' => $item->product_variant_id,
                            'variant_name' => $item->variant ? $item->variant->name : null,
                            'quantity' => $item->quantity,
                            'unit_price' => $item->unit_price,
                            'total_price' => $item->total_price,
                            'product_category' => $item->product->category ? $item->product->category->name : null
                        ];
                    }),
                    'items_summary' => [
                        'total_items' => $order->items->sum('quantity'),
                        'items_count' => $order->items->count(),
                        'products' => $order->items->map(function ($item) {
                            return [
                                'name' => $item->product->name,
                                'variant' => $item->variant ? $item->variant->name : null,
                                'quantity' => $item->quantity,
                                'total_price' => $item->total_price
                            ];
                        })
                    ],
                    'created_at' => $order->created_at,
                    'updated_at' => $order->updated_at
                ];
            });

            \Log::info('‚úÖ Commandes format√©es avec succ√®s', ['count' => $formattedOrders->count()]);
            
            return response()->json([
                'success' => true,
                'message' => 'Commandes r√©cup√©r√©es avec succ√®s',
                'data' => [
                    'orders' => $formattedOrders,
                    'total' => $formattedOrders->count(),
                    'summary' => [
                        'total_orders' => $formattedOrders->count(),
                        'total_spent' => $formattedOrders->sum('total_amount'),
                        'status_breakdown' => [
                            'en_attente' => $formattedOrders->where('status', 'en_attente')->count(),
                            'accept√©e' => $formattedOrders->where('status', 'accept√©e')->count(),
                            'pr√™te' => $formattedOrders->where('status', 'pr√™te')->count(),
                            'en_cours' => $formattedOrders->where('status', 'en_cours')->count(),
                            'disponible' => $formattedOrders->where('status', 'disponible')->count(),
                            'annul√©e' => $formattedOrders->where('status', 'annul√©e')->count()
                        ]
                    ]
                ]
            ], 200);

        } catch (\Exception $e) {
            \Log::error('‚ùå Erreur lors de la r√©cup√©ration des commandes', [
                'error' => $e->getMessage(),
                'user_id' => $request->user()?->id
            ]);
            
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors de la r√©cup√©ration des commandes',
                'error' => 'Une erreur est survenue'
            ], 500);
        }
    }

    /**
     * Cr√©er une commande pour un client non authentifi√© (inscription rapide)
     * 
     * @param Request $request - Donn√©es de la commande
     * @return JsonResponse - Commande cr√©√©e avec r√©sum√©
     */
    public function storeGuest(Request $request): JsonResponse
    {
        try {
            // Validation des donn√©es
            $validator = Validator::make($request->all(), [
                'session_id' => 'required|string',
                'notes' => 'nullable|string|max:1000',
                'whatsapp_phone' => 'nullable|string'
            ], [
                'session_id.required' => 'L\'ID de session du panier est requis',
                'notes.max' => 'Les notes ne peuvent pas d√©passer 1000 caract√®res'
            ]);

            // Si validation √©choue, retourner les erreurs
            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Erreur de validation',
                    'errors' => $validator->errors()
                ], 422);
            }

            // R√©cup√©rer la session du panier
            $cartSession = CartSession::where('session_id', $request->session_id)
                ->where('expires_at', '>', now())
                ->with(['items.product', 'items.variant'])
                ->first();

            if (!$cartSession) {
                return response()->json([
                    'success' => false,
                    'message' => 'Session de panier invalide ou expir√©e'
                ], 404);
            }

            // V√©rifier que le panier n'est pas vide
            if ($cartSession->items->isEmpty()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Le panier est vide'
                ], 422);
            }

            // V√©rifier la disponibilit√© des produits
            $unavailableItems = [];
            foreach ($cartSession->items as $item) {
                if ($item->variant) {
                    if (!$item->variant->isAvailable()) {
                        $unavailableItems[] = $item->product->name . ' - ' . $item->variant->name;
                    }
                } elseif (!$item->product->is_active) {
                    $unavailableItems[] = $item->product->name;
                }
            }

            if (!empty($unavailableItems)) {
                return response()->json([
                    'success' => false,
                    'message' => 'Certains produits ne sont plus disponibles',
                    'error' => 'Produits indisponibles : ' . implode(', ', $unavailableItems)
                ], 422);
            }

            // D√©marrer une transaction
            DB::beginTransaction();

            try {
                // Calculer le total de la commande
                $totalAmount = $cartSession->items->sum(function ($item) {
                    $price = $item->variant ? $item->variant->price : ($item->product->base_price ?? 0);
                    return $price * $item->quantity;
                });

                // Cr√©er un utilisateur temporaire pour les clients non authentifi√©s
                \Log::info('üÜï Cr√©ation d\'un utilisateur temporaire pour commande guest');
                $tempUser = User::create([
                    'name' => 'Client ' . substr($request->session_id, -6),
                    'email' => 'temp_' . time() . '@bs-shop.com',
                    'whatsapp_phone' => '+33000000000', // T√©l√©phone temporaire
                    'role' => 'client',
                    'password' => bcrypt(Str::random(16)),
                    'is_active' => true
                ]);
                $clientId = $tempUser->id;
                
                // Mettre √† jour la session avec le nouvel utilisateur
                $cartSession->update(['client_id' => $clientId]);
                \Log::info('üÜï Nouvel utilisateur temporaire cr√©√©', ['client_id' => $clientId]);

                // Cr√©er la commande
                \Log::info('üì¶ Cr√©ation de la commande guest', [
                    'client_id' => $clientId,
                    'total_amount' => $totalAmount
                ]);
                
                $order = Order::create([
                    'client_id' => $clientId,
                    'total_amount' => $totalAmount,
                    'status' => 'en_attente',
                    'notes' => $request->notes,
                    'whatsapp_message_id' => null
                ]);
                
                \Log::info('‚úÖ Commande guest cr√©√©e avec succ√®s', [
                    'order_id' => $order->id,
                    'client_id' => $order->client_id,
                    'total_amount' => $order->total_amount
                ]);

                // Cr√©er les √©l√©ments de commande
                foreach ($cartSession->items as $cartItem) {
                    $unitPrice = $cartItem->variant ? $cartItem->variant->price : ($cartItem->product->base_price ?? 0);
                    $totalPrice = $unitPrice * $cartItem->quantity;

                    OrderItem::create([
                        'order_id' => $order->id,
                        'product_id' => $cartItem->product_id,
                        'product_variant_id' => $cartItem->product_variant_id,
                        'quantity' => $cartItem->quantity,
                        'unit_price' => $unitPrice,
                        'total_price' => $totalPrice
                    ]);

                    // Mettre √† jour le stock si c'est une variante
                    if ($cartItem->variant && $cartItem->variant->stock_quantity !== null) {
                        $cartItem->variant->decrement('stock_quantity', $cartItem->quantity);
                    }
                }

                // Vider le panier
                $cartSession->items()->delete();

                // Valider la transaction
                DB::commit();

                // Charger les relations pour la r√©ponse
                $order->load(['items.product', 'items.variant', 'client']);

                // Formater la r√©ponse
                $formattedOrder = [
                    'id' => $order->id,
                    'order_number' => 'CMD-' . str_pad($order->id, 6, '0', STR_PAD_LEFT),
                    'status' => $order->status,
                    'total_amount' => $order->total_amount,
                    'notes' => $order->notes,
                    'client_info' => [
                        'id' => $order->client_id,
                        'name' => $order->client->name,
                        'email' => $order->client->email,
                        'is_existing_user' => false
                    ],
                    'items' => $order->items->map(function ($item) {
                        return [
                            'product_name' => $item->product->name,
                            'variant_name' => $item->variant ? $item->variant->name : null,
                            'quantity' => $item->quantity,
                            'unit_price' => $item->unit_price,
                            'total_price' => $item->total_price
                        ];
                    }),
                    'summary' => [
                        'total_items' => $order->items->sum('quantity'),
                        'items_count' => $order->items->count(),
                        'created_at' => $order->created_at
                    ]
                ];

                return response()->json([
                    'success' => true,
                    'message' => 'Commande cr√©√©e avec succ√®s',
                    'data' => [
                        'order' => $formattedOrder
                    ]
                ], 201);

            } catch (\Exception $e) {
                DB::rollback();
                throw $e;
            }

        } catch (\Exception $e) {
            \Log::error('‚ùå Erreur lors de la cr√©ation de la commande guest', [
                'error' => $e->getMessage(),
                'session_id' => $request->session_id
            ]);
            
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors de la cr√©ation de la commande',
                'error' => 'Une erreur est survenue'
            ], 500);
        }
    }

    /**
     * Voir une commande sp√©cifique du client connect√©
     * 
     * @param Request $request - Requ√™te avec utilisateur connect√©
     * @param int $id - ID de la commande
     * @return JsonResponse - D√©tails de la commande
     */
    public function show(Request $request, int $id): JsonResponse
    {
        try {
            // R√©cup√©rer l'utilisateur connect√©
            $user = $request->user();
            
            if (!$user) {
                return response()->json([
                    'success' => false,
                    'message' => 'Utilisateur non connect√©'
                ], 401);
            }

            // R√©cup√©rer la commande avec ses relations
            $order = Order::where('id', $id)
                ->where('client_id', $user->id)
                ->with(['items.product.category', 'items.variant'])
                ->first();

            if (!$order) {
                return response()->json([
                    'success' => false,
                    'message' => 'Commande non trouv√©e'
                ], 404);
            }

            // Formater la commande
            $formattedOrder = [
                'id' => $order->id,
                'order_number' => 'CMD-' . str_pad($order->id, 6, '0', STR_PAD_LEFT),
                'status' => $order->status,
                'total_amount' => $order->total_amount,
                'notes' => $order->notes,
                'items' => $order->items->map(function ($item) {
                    return [
                        'id' => $item->id,
                        'product' => [
                            'id' => $item->product->id,
                            'name' => $item->product->name,
                            'slug' => $item->product->slug,
                            'image_main' => $item->product->image_main,
                            'category' => [
                                'id' => $item->product->category->id,
                                'name' => $item->product->category->name
                            ]
                        ],
                        'variant' => $item->variant ? [
                            'id' => $item->variant->id,
                            'name' => $item->variant->name,
                            'sku' => $item->variant->sku
                        ] : null,
                        'quantity' => $item->quantity,
                        'unit_price' => $item->unit_price,
                        'total_price' => $item->total_price
                    ];
                }),
                'summary' => [
                    'total_items' => $order->items->sum('quantity'),
                    'items_count' => $order->items->count(),
                    'has_variants' => $order->items->whereNotNull('variant')->count() > 0
                ],
                'timeline' => [
                    'created_at' => $order->created_at,
                    'updated_at' => $order->updated_at
                ]
            ];

            return response()->json([
                'success' => true,
                'message' => 'Commande r√©cup√©r√©e avec succ√®s',
                'data' => $formattedOrder
            ], 200);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors de la r√©cup√©ration de la commande',
                'error' => 'Une erreur est survenue'
            ], 500);
        }
    }

    /**
     * Liste de toutes les commandes (ADMIN ONLY)
     * 
     * @param Request $request - Requ√™te avec utilisateur admin
     * @return JsonResponse - Liste de toutes les commandes
     */
    public function adminIndex(Request $request): JsonResponse
    {
        try {
            // V√©rifier que l'utilisateur est admin
            if (!$request->user() || !$request->user()->isAdmin()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Acc√®s non autoris√©'
                ], 403);
            }

            // R√©cup√©rer toutes les commandes avec pagination
            $orders = Order::with(['client', 'items.product', 'items.variant'])
                ->orderBy('created_at', 'desc')
                ->paginate(20);

            // Formater les commandes
            $formattedOrders = $orders->getCollection()->map(function ($order) {
                return [
                    'id' => $order->id,
                    'order_number' => 'CMD-' . str_pad($order->id, 6, '0', STR_PAD_LEFT),
                    'client' => [
                        'id' => $order->client->id,
                        'name' => $order->client->name,
                        'whatsapp_phone' => $order->client->whatsapp_phone
                    ],
                    'status' => $order->status,
                    'total_amount' => $order->total_amount,
                    'items' => $order->items->map(function ($item) {
                        return [
                            'id' => $item->id,
                            'product_name' => $item->product->name,
                            'variant_name' => $item->variant ? $item->variant->name : null,
                            'quantity' => $item->quantity,
                            'price' => $item->unit_price,
                            'total_price' => $item->total_price
                        ];
                    }),
                    'items_summary' => [
                        'total_items' => $order->items->sum('quantity'),
                        'items_count' => $order->items->count()
                    ],
                    'created_at' => $order->created_at,
                    'updated_at' => $order->updated_at
                ];
            });

        return response()->json([
            'success' => true,
                'message' => 'Commandes r√©cup√©r√©es avec succ√®s',
                'data' => [
                    'orders' => $formattedOrders,
                    'pagination' => [
                        'current_page' => $orders->currentPage(),
                        'last_page' => $orders->lastPage(),
                        'per_page' => $orders->perPage(),
                        'total' => $orders->total()
                    ],
                    'summary' => [
                        'total_orders' => $orders->total(),
                        'total_revenue' => Order::sum('total_amount'),
                        'status_breakdown' => [
                            'en_attente' => Order::where('status', 'en_attente')->count(),
                            'accept√©e' => Order::where('status', 'accept√©e')->count(),
                            'pr√™te' => Order::where('status', 'pr√™te')->count(),
                            'en_cours' => Order::where('status', 'en_cours')->count(),
                            'disponible' => Order::where('status', 'disponible')->count(),
                            'annul√©e' => Order::where('status', 'annul√©e')->count()
                        ]
                    ]
                ]
            ], 200);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors de la r√©cup√©ration des commandes',
                'error' => 'Une erreur est survenue'
            ], 500);
        }
    }

    /**
     * Voir les d√©tails d'une commande (ADMIN ONLY)
     * 
     * @param Request $request - Requ√™te avec utilisateur admin
     * @param int $id - ID de la commande
     * @return JsonResponse - D√©tails complets de la commande
     */
    public function adminShow(Request $request, int $id): JsonResponse
    {
        try {
            // V√©rifier que l'utilisateur est admin
            if (!$request->user() || !$request->user()->isAdmin()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Acc√®s non autoris√©'
                ], 403);
            }

            // R√©cup√©rer la commande avec toutes ses relations
            $order = Order::with([
                'client',
                'items.product.category',
                'items.variant'
            ])->find($id);

            if (!$order) {
                return response()->json([
                    'success' => false,
                    'message' => 'Commande non trouv√©e'
                ], 404);
            }

            // Formater la commande
            $formattedOrder = [
                'id' => $order->id,
                'order_number' => 'CMD-' . str_pad($order->id, 6, '0', STR_PAD_LEFT),
                'client' => [
                    'id' => $order->client->id,
                    'name' => $order->client->name,
                    'email' => $order->client->email,
                    'whatsapp_phone' => $order->client->whatsapp_phone
                ],
                'status' => $order->status,
                'total_amount' => $order->total_amount,
                'notes' => $order->notes,
                'whatsapp_message_id' => $order->whatsapp_message_id,
                'items' => $order->items->map(function ($item) {
                    return [
                        'id' => $item->id,
                        'product' => [
                            'id' => $item->product->id,
                            'name' => $item->product->name,
                            'slug' => $item->product->slug,
                            'image_main' => $item->product->image_main,
                            'category' => [
                                'id' => $item->product->category->id,
                                'name' => $item->product->category->name
                            ]
                        ],
                        'variant' => $item->variant ? [
                            'id' => $item->variant->id,
                            'name' => $item->variant->name,
                            'sku' => $item->variant->sku,
                            'price' => $item->variant->price
                        ] : null,
                        'quantity' => $item->quantity,
                        'unit_price' => $item->unit_price,
                        'total_price' => $item->total_price
                    ];
                }),
                'summary' => [
                    'total_items' => $order->items->sum('quantity'),
                    'items_count' => $order->items->count(),
                    'has_variants' => $order->items->whereNotNull('variant')->count() > 0
                ],
                'timeline' => [
                    'created_at' => $order->created_at,
                    'updated_at' => $order->updated_at
                ]
            ];

        return response()->json([
            'success' => true,
                'message' => 'Commande r√©cup√©r√©e avec succ√®s',
                'data' => $formattedOrder
            ], 200);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors de la r√©cup√©ration de la commande',
                'error' => 'Une erreur est survenue'
            ], 500);
        }
    }

    /**
     * Mettre √† jour le statut d'une commande (ADMIN ONLY)
     * 
     * @param Request $request - Nouveau statut
     * @param int $id - ID de la commande
     * @return JsonResponse - Commande mise √† jour
     */
    public function updateStatus(Request $request, int $id): JsonResponse
    {
        try {
            // V√©rifier que l'utilisateur est admin
            if (!$request->user() || !$request->user()->isAdmin()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Acc√®s non autoris√©'
                ], 403);
            }

            // Validation des donn√©es
            $validator = Validator::make($request->all(), [
                'status' => 'required|in:en_attente,accept√©e,pr√™te,en_cours,disponible,annul√©e',
                'notes' => 'nullable|string|max:1000'
            ], [
                'status.required' => 'Le statut est requis',
                'status.in' => 'Statut invalide',
                'notes.max' => 'Les notes ne peuvent pas d√©passer 1000 caract√®res'
            ]);

            // Si validation √©choue, retourner les erreurs
            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Erreur de validation',
                    'errors' => $validator->errors()
                ], 422);
            }

            // R√©cup√©rer la commande
            $order = Order::with(['client'])->find($id);

            if (!$order) {
                return response()->json([
                    'success' => false,
                    'message' => 'Commande non trouv√©e'
                ], 404);
            }

            // Mettre √† jour le statut
            $oldStatus = $order->status;
            $order->status = $request->status;
            
            if ($request->has('notes')) {
                $order->notes = $request->notes;
            }
            
            $order->save();

            // Formater la r√©ponse
            $formattedOrder = [
                'id' => $order->id,
                'order_number' => 'CMD-' . str_pad($order->id, 6, '0', STR_PAD_LEFT),
                'status' => $order->status,
                'status_changed' => $oldStatus !== $order->status,
                'old_status' => $oldStatus,
                'client' => [
                    'id' => $order->client->id,
                    'name' => $order->client->name,
                    'whatsapp_phone' => $order->client->whatsapp_phone
                ],
                'total_amount' => $order->total_amount,
                'notes' => $order->notes,
                'updated_at' => $order->updated_at
            ];

        return response()->json([
            'success' => true,
                'message' => 'Statut de la commande mis √† jour avec succ√®s',
                'data' => $formattedOrder
            ], 200);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors de la mise √† jour du statut',
                'error' => 'Une erreur est survenue'
            ], 500);
        }
    }

    /**
     * G√©n√©rer le message WhatsApp pour la commande
     * 
     * @param Order $order - La commande
     * @return string - Message WhatsApp format√©
     */
    private function generateWhatsAppMessage(Order $order): string
    {
        $message = "üõí *NOUVELLE COMMANDE BS SHOP*\n\n";
        $message .= "üìã *Commande #" . str_pad($order->id, 6, '0', STR_PAD_LEFT) . "*\n";
        $message .= "üí∞ *Total: " . number_format($order->total_amount, 2) . " ‚Ç¨*\n\n";
        
        $message .= "üì¶ *PRODUITS COMMAND√âS:*\n";
        foreach ($order->items as $item) {
            $productName = $item->product->name;
            $variantName = $item->variant ? " - " . $item->variant->name : "";
            $quantity = $item->quantity;
            $price = number_format($item->total_price, 2);
            
            $message .= "‚Ä¢ {$productName}{$variantName} x{$quantity} = {$price}‚Ç¨\n";
        }
        
        $message .= "\nüìù *NOTES:* " . ($order->notes ?: "Aucune");
        $message .= "\n\n‚úÖ *Confirmez cette commande en r√©pondant 'OUI'*";
        
        return $message;
    }
}
